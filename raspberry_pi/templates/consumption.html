{% extends "base.html" %}

{% block title %}Consommation de Pellets - Contr√¥leur Palazzetti{% endblock %}
{% block subtitle %}Suivi de la consommation de pellets{% endblock %}
{% block consumption_active %}active{% endblock %}

{% block extra_css %}
<style>
    .container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 600px;
        width: 100%;
        text-align: center;
        margin: 0 auto;
    }

    /* Mobile first - styles par d√©faut pour mobile */
    @media (max-width: 480px) {
        .container {
            padding: 15px;
            border-radius: 10px;
            margin: 5px;
        }
    }

    /* Tablette */
    @media (min-width: 481px) and (max-width: 768px) {
        .container {
            padding: 25px;
            border-radius: 15px;
        }
    }

    /* Desktop */
    @media (min-width: 769px) {
        .container {
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
    }

    .consumption-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 5px solid #28a745;
    }

    .consumption-value {
        font-size: 2.5em;
        font-weight: 300;
        color: #333;
        margin: 10px 0;
    }

    .consumption-label {
        font-size: 1.1em;
        color: #666;
        margin-bottom: 10px;
    }

    .consumption-details {
        font-size: 0.9em;
        color: #888;
        margin-top: 10px;
    }

    .controls {
        margin-top: 30px;
    }

    .control-group {
        margin-bottom: 25px;
    }

    .control-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #333;
        text-align: left;
    }

    .btn-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-danger:hover {
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .btn.loading {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .interface-inactive {
        opacity: 0.5;
        pointer-events: none;
    }

    .error-display {
        display: none;
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 10px;
        padding: 8px;
        background: #fff5f5;
        border-radius: 5px;
        border-left: 3px solid #dc3545;
    }

    .info-display {
        display: none;
        color: #17a2b8;
        font-size: 0.9em;
        margin-top: 10px;
        padding: 8px;
        background: #f0f9ff;
        border-radius: 5px;
        border-left: 3px solid #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="consumption-card">
        <div class="consumption-label">Consommation totale de pellets</div>
        <div class="consumption-value" id="totalConsumption">--</div>
        <div class="consumption-details" id="totalConsumptionDetails">Chargement...</div>
    </div>

    <div class="consumption-card">
        <div class="consumption-label">Consommation depuis le dernier entretien</div>
        <div class="consumption-value" id="maintenanceConsumption">--</div>
        <div class="consumption-details" id="maintenanceConsumptionDetails">Aucun reset enregistr√©</div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label class="control-label">Actions</label>
            <div class="btn-group">
                <button class="btn btn-success" id="refreshBtn" onclick="refreshConsumption()" disabled>
                    üîÑ Actualiser
                </button>
                <button class="btn btn-danger" id="resetBtn" onclick="resetMaintenance()" disabled>
                    üîß Reset entretien
                </button>
            </div>
        </div>
    </div>

    <div class="error-display" id="errorDisplay">
        <strong>‚ö†Ô∏è Erreur:</strong> <span id="errorMessage">Aucune erreur</span>
    </div>

    <div class="info-display" id="infoDisplay">
        <strong>‚ÑπÔ∏è Info:</strong> <span id="infoMessage">Aucune information</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('=== PAGE CONSOMMATION CHARG√âE ===');
    
    // √âl√©ments DOM
    const totalConsumption = document.getElementById('totalConsumption');
    const totalConsumptionDetails = document.getElementById('totalConsumptionDetails');
    const maintenanceConsumption = document.getElementById('maintenanceConsumption');
    const maintenanceConsumptionDetails = document.getElementById('maintenanceConsumptionDetails');
    const refreshBtn = document.getElementById('refreshBtn');
    const resetBtn = document.getElementById('resetBtn');
    const errorDisplay = document.getElementById('errorDisplay');
    const errorMessage = document.getElementById('errorMessage');
    const infoDisplay = document.getElementById('infoDisplay');
    const infoMessage = document.getElementById('infoMessage');

    // √âtat actuel
    let currentState = {
        connected: false,
        synchronized: false,
        totalConsumption: null,
        maintenanceConsumption: null
    };

    // Mise √† jour de l'affichage de la consommation totale
    function updateTotalConsumption(consumption) {
        if (consumption !== null && consumption !== undefined) {
            totalConsumption.textContent = consumption.toFixed(1);
            totalConsumptionDetails.textContent = `Derni√®re mise √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
        } else {
            totalConsumption.textContent = '--';
            totalConsumptionDetails.textContent = 'Impossible de lire la consommation';
        }
    }

    // Mise √† jour de l'affichage de la consommation de maintenance
    function updateMaintenanceConsumption(data) {
        if (data && data.consumption_since_reset !== null) {
            maintenanceConsumption.textContent = data.consumption_since_reset.toFixed(1);
            maintenanceConsumptionDetails.textContent = `Depuis le: ${new Date(data.reset_date).toLocaleDateString('fr-FR')}`;
        } else {
            maintenanceConsumption.textContent = '--';
            maintenanceConsumptionDetails.textContent = 'Aucun reset enregistr√©';
        }
    }

    // Mise √† jour de l'√©tat de l'interface
    function updateInterfaceState() {
        const isReady = currentState.connected && currentState.synchronized;
        const container = document.querySelector('.container');
        
        // D√©sactiver/activer tous les contr√¥les
        refreshBtn.disabled = !isReady;
        resetBtn.disabled = !isReady;
        
        // Appliquer le style d'inactivit√©
        if (isReady) {
            container.classList.remove('interface-inactive');
        } else {
            container.classList.add('interface-inactive');
        }
    }

        // Actualiser la consommation (optimis√© avec une seule requ√™te)
        function refreshConsumption() {
            if (refreshBtn.disabled) return;
            
            setRefreshLoading(true);
            hideMessages();
            
            // Utiliser l'API optimis√©e qui r√©cup√®re tout en une seule requ√™te
            fetchWithCancellation('/api/consumption_status')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 503) {
                        throw new Error('Po√™le non connect√© - impossible de lire la consommation');
                    } else {
                        throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                return response.json();
            })
            .then(data => {
                if (data.connected && data.synchronized) {
                    // Mettre √† jour toutes les donn√©es
                    currentState.totalConsumption = data.total_consumption;
                    currentState.maintenanceConsumption = data.maintenance_consumption;
                    
                    updateTotalConsumption(data.total_consumption);
                    updateMaintenanceConsumption(data.maintenance_consumption);
                    
                    hideMessages();
                } else {
                    // G√©rer les erreurs
                    updateTotalConsumption(null);
                    updateMaintenanceConsumption(null);
                    
                    if (!data.connected) {
                        showError('Po√™le non connect√© - impossible de lire la consommation');
                    } else if (data.error) {
                        showError(data.error);
                    }
                }
            })
            .catch(error => {
                if (error.name !== 'AbortError') {
                    console.error('Erreur lors de la lecture de la consommation:', error);
                    updateTotalConsumption(null);
                    updateMaintenanceConsumption(null);
                    showError(error.message);
                }
            })
            .finally(() => {
                setRefreshLoading(false);
            });
        }

    // R√©initialiser le compteur de maintenance
    function resetMaintenance() {
        if (resetBtn.disabled) return;
        
        if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser le compteur de maintenance ?\n\nCette action enregistrera la consommation actuelle comme point de d√©part pour le prochain entretien.')) {
            return;
        }
        
        setResetLoading(true);
        hideMessages();
        
        fetchWithCancellation('/api/reset_maintenance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showInfo('Compteur de maintenance r√©initialis√© avec succ√®s');
                    // Actualiser l'affichage avec l'API optimis√©e
                    refreshConsumption();
                } else {
                    showError('Erreur lors de la r√©initialisation: ' + data.error);
                }
            })
        .catch(error => {
            if (error.name !== 'AbortError') {
                console.error('Erreur lors de la r√©initialisation:', error);
                showError('Erreur de communication lors de la r√©initialisation');
            }
        })
        .finally(() => {
            setResetLoading(false);
        });
    }

    // Gestion du loading pour le bouton d'actualisation
    function setRefreshLoading(loading) {
        if (loading) {
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Actualisation...';
            refreshBtn.classList.add('loading');
        } else {
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'üîÑ Actualiser';
            refreshBtn.classList.remove('loading');
        }
    }

    // Gestion du loading pour le bouton de reset
    function setResetLoading(loading) {
        if (loading) {
            resetBtn.disabled = true;
            resetBtn.textContent = 'R√©initialisation...';
            resetBtn.classList.add('loading');
        } else {
            resetBtn.disabled = false;
            resetBtn.textContent = 'üîß Reset entretien';
            resetBtn.classList.remove('loading');
        }
    }

    // Afficher un message d'erreur
    function showError(message) {
        errorMessage.textContent = message;
        errorDisplay.style.display = 'block';
        infoDisplay.style.display = 'none';
    }

    // Afficher un message d'information
    function showInfo(message) {
        infoMessage.textContent = message;
        infoDisplay.style.display = 'block';
        errorDisplay.style.display = 'none';
    }

    // Masquer tous les messages
    function hideMessages() {
        errorDisplay.style.display = 'none';
        infoDisplay.style.display = 'none';
    }

    // V√©rifier l'√©tat de connexion et charger les donn√©es de consommation (optimis√©)
    function checkConnectionStatus() {
        fetchWithCancellation('/api/consumption_status')
        .then(response => {
            if (!response.ok) {
                if (response.status === 503) {
                    throw new Error('Po√™le non connect√©');
                } else {
                    throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                }
            }
            return response.json();
        })
        .then(data => {
            currentState.connected = data.connected;
            currentState.synchronized = data.synchronized;
            updateInterfaceState();
            
            if (data.connected && data.synchronized) {
                // Donn√©es disponibles directement depuis l'API optimis√©e
                currentState.totalConsumption = data.total_consumption;
                currentState.maintenanceConsumption = data.maintenance_consumption;
                
                updateTotalConsumption(data.total_consumption);
                updateMaintenanceConsumption(data.maintenance_consumption);
                
                hideMessages();
            } else {
                // Si pas connect√©, afficher des messages informatifs
                updateTotalConsumption(null);
                updateMaintenanceConsumption(null);
                if (!data.connected) {
                    showError('Po√™le non connect√© - impossible de lire la consommation');
                } else if (data.error) {
                    showError(data.error);
                }
            }
        })
        .catch(error => {
            if (error.name !== 'AbortError') {
                console.error('Erreur lors de la v√©rification de l\'√©tat:', error);
                currentState.connected = false;
                currentState.synchronized = false;
                updateInterfaceState();
                updateTotalConsumption(null);
                updateMaintenanceConsumption(null);
                showError(error.message);
            }
        });
    }

    // Initialisation
    function init() {
        console.log('Initialisation de la page de consommation...');
        
        // Initialiser l'affichage
        updateTotalConsumption(null);
        updateMaintenanceConsumption(null);
        updateInterfaceState();
        
        // V√©rifier l'√©tat de connexion
        checkConnectionStatus();
    }

    // Charger l'√©tat initial quand le DOM est pr√™t
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM charg√©, initialisation de la page de consommation...');
        init();
    });
</script>
{% endblock %}
